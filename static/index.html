<!DOCTYPE html>
<html lang="ch" style="height: 100%;">
<head>
    <meta charset="utf-8">
    <!--meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"-->

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/dygraph.min.css">

    <title>ArgosController</title>

    <link rel="icon" href="/static/icon.jpg" type="image/x-icon">  <!-- æ·»åŠ ä¸ªå›¾æ ‡è£…ä½œå¾ˆæ­£å¼çš„æ ·å­~~~ -->
    <link rel="shortcut icon" href="/static/icon.jpg" type="image/x-icon">

    <style>
        body {
            background-color: black;
        }

        .container {
            margin-top: 20px;
            width: inherit;
            display: grid;
            grid-template-columns: 60px auto 250px 250px;
            grid-template-rows: 60px auto;
            grid-column-gap: 10px;
            grid-row-gap: 10px;
            justify-items: stretch;
            align-items: stretch;
            grid-template-areas:
                "icon header header header"
                "basic main info control";
        }

        .icon {
            grid-area: icon;
            background-image: url("/static/icon.jpg");
            background-size:cover;
        }

        .header {
            grid-area: header;
            align-self: center;
            font-size: 300%;
            font-weight: bolder;
            color: antiquewhite;
        }

        .basic {
            grid-area: basic;
        }

        .basic-button {
            width: 100%;
            height: 60px;
            margin-bottom: 10px;
        }

        .card {
            margin-bottom: 10px;
        }

        .card-body {
            font-size: 80%;
        }

        .modified-warning {
            color: firebrick;
            font-size: 80%;
            font-weight: bold;
            display: none;
        }

    </style>

</head>
<body>

    <div class="container">
        <div class="icon"></div>
        <div class="header">Argos Controller <font style="font-size: 50%;">web version v0.1</font></div>
        <div class="basic">
            <button type="button" class="btn btn-success basic-button" id="Init" onclick="leftButtonClicked('Init');">Init</button>
            <button type="button" class="btn btn-danger basic-button" id="Stop" disabled="disabled" onclick="leftButtonClicked('Stop');">Stop</button>
            <button type="button" class="btn btn-warning basic-button" style="height: 200px;" id="Sing">Sing</button> <!-- è¿™ä¸ªæŒ‰é’®ç”¨æ¥å¯¹mainåŒºåŸŸæ˜¾ç¤ºçš„å›¾åƒè¿›è¡Œæš‚åœ -->
            <button type="button" class="btn btn-primary basic-button" id="Calib" disabled="disabled">Calib</button> <!-- è‡ªåŠ¨æ ¡å‡†å‡½æ•°ï¼ŒTODO -->
            <button type="button" class="btn btn-light basic-button" id="Trig" onclick="leftButtonClicked('Trig');">Trig</button>
            <button type="button" class="btn btn-dark basic-button" id="Reset" onclick="leftButtonClicked('Reset');">Reset</button>
        </div>
        <div style="grid-area: main;">
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#AllInOneGraph" aria-expanded="true" onclick="updateAllInOneGraph();">All-in-one Graph</button></div>
                <div id="AllInOneGraph" class="collapse show"><div class="card-body">
                    <div style="height: 200px;" id="AllInOneGraph-0"></div>
                </div></div>
            </div>
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#ManualGraph" aria-expanded="true" onclick="updateManualGraph();">Manual Graph</button></div>
                <div id="ManualGraph" class="collapse show"><div class="card-body">
                    <div style="height: 200px;" id="ManualGraph-0"></div>
                </div></div>
            </div>
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#OriginGraph" aria-expanded="true" onclick="updateAllOriginGraph();">Original Graph</button></div>
                <div id="OriginGraph" class="collapse show"><div class="card-body" id="OriginGraph-body">
                    
                </div></div>
            </div>
        </div>
        <div style="grid-area: info;">
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#SystemBasicInfo" aria-expanded="true">System Basic Information</button></div>
                <div id="SystemBasicInfo" class="collapse show"><div class="card-body">
                    <!-- æ˜¾ç¤ºç³»ç»ŸåŸºæœ¬æ¶ˆæ¯ -->
                    Connected: <strong id="SystemBasicInfo-Connected" style="color: red;">False</strong><br/>
                    System version: <strong id="SystemBasicInfo-SystemVersion">UNKNOWN</strong>
                    Run status: <strong id="SystemBasicInfo-RunStatus">UNKNOWN</strong>
                </div></div>
            </div>
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#SystemLogs" aria-expanded="true">System Log</button></div>
                <div id="SystemLogs" class="collapse show"><div class="card-body" id="SystemLogs-body" style="padding-bottom: 0px;">
                    <!-- æ˜¾ç¤ºlogç­‰å¼¹å‡ºæ¡† -->
                </div></div>
            </div>
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#SystemExtraInfos" aria-expanded="true">System Extra Information</button></div>
                <div id="SystemExtraInfos" class="collapse show"><div class="card-body" id="SystemExtraInfos-body">
                    <!-- æ˜¾ç¤ºç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Œæ¯”å¦‚æ¸©åº¦ç­‰ -->
                </div></div>
            </div>
        </div>
        <div style="grid-area: control;">
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#BasicSettings" aria-expanded="true">Basic Settings</button></div>
                <div id="BasicSettings" class="collapse show"><div class="card-body">
                    <!-- è®¾ç½®ä½¿ç”¨çš„Irisæ¨¡å—ç¼–å·ç­‰ç­‰ -->
                    <strong style="color: red;">* must stop and reinitialize to set</strong><br/><br/>
                    <font>Iris count: (0 for simulation)</font>
                    <div class="input-group">
                        <div class="input-group-prepend"><button type="button" class="btn btn-success" onclick="IrisCountChangeValue(-1);">-</button></div>
                        <input type="text" class="form-control" placeholder="Iris count" id="BasicSettings-IrisCount" value="0"
                            onKeyPress="if (event.keyCode == 13) event.srcElement.blur(); if ((event.keyCode<48 || event.keyCode>57)) event.returnValue=false;"
                            onblur="generalValChanged('BasicSettings-IrisCount');" >
                        <div class="input-group-append"><button type="button" class="btn btn-success" onclick="IrisCountChangeValue(1);">+</button></div>
                    </div>
                    <div class="modified-warning" id="m-BasicSettings-IrisCount">* argument modified but not sync yet.</div>
                    <div style="margin-left: 80px; margin-right: -20px;">channelğŸ‘‡<font style="margin-left: 27px;">triggerğŸ‘‡</font></div>
                    <div id="IrisDevicesBox"></div>
                </div></div>
            </div>
            <div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#GainSettings" aria-expanded="true">Gain Settings</button></div>
                <div id="GainSettings" class="collapse"><div class="card-body">
                    <!-- è®¾ç½®æ¯ä¸€ä¸ªIrisçš„Gainï¼Œå„ç§Gain..... -->
                    <div id="GainSettings-RXDIV">
                        
                    </div>
                    <div id="GainSettings-TXDIV">

                    </div>
                </div></div>
            </div>
            <button style="width: 100%; margin-bottom: 10px;" class="btn btn-danger" onclick="rejectAllModification();">reject all modification</button>
            <button style="width: 100%; margin-bottom: 10px;" class="btn btn-success" onclick="syncSettingsToServer();">sync settings <strong>to</strong> server</button>
            <div class="btn-group btn-group-toggle" data-toggle="buttons" style="width: 100%; margin-bottom: 10px;">
                <label class="btn btn-secondary active" style="width: 50%;" onclick="changeSetMode('manual');">
                    <input type="radio" name="options" autocomplete="off" checked> Manual set
                </label>
                <label class="btn btn-secondary" style="width: 50%;" onclick="changeSetMode('auto');">
                    <input type="radio" name="options" autocomplete="off"> Auto set
                </label>
            </div>
            <!--div class="card">
                <div class="card-header"><button class="btn btn-link" data-toggle="collapse" data-target="#GainSettings" aria-expanded="true">Gain Settings</button></div>
                <div id="GainSettings" class="collapse" aria-labelledby="headingOne" data-parent="#accordion"><div class="card-body">
                    å…¶ä»–è®¾ç½®ï¼Ÿè¿˜æ²¡æƒ³å¥½ï¼Œè¿™é‡Œç•™ä¸€ä¸ªæ¨¡æ¿å§
                </div></div>
            </div-->
        </div>
    </div>

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/jsrender.min.js"></script>
    <script src="/static/js/socket.io.min.js"></script>
    <script src="/static/js/jquery.nicescroll.min.js"></script>
    <script src="/static/js/qunee-min.js"></script>
    <script src="/static/js/jcanvas.min.js"></script>
    <script src="/static/js/dygraph.min.js"></script>

    <script id='IrisSerialInput' type="text/html">
        <div class="input-group" style="margin-bottom: 5px;" id="BasicSettings-IrisDevices-Box-{{:num}}">
            <div class="input-group-prepend" style="margin-left: -15px;"><strong style="font-size: 170%">{{:num}}&nbsp;</strong></div>
            <input type="text" class="form-control" placeholder="serial num" id="BasicSettings-IrisDevices-Serial-{{:num}}"
                onKeyPress="if (event.keyCode == 13) event.srcElement.blur();" onblur="generalValChanged('BasicSettings-IrisDevices-{{:num}}');">
            <div class="input-group-prepend">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                    style="width: 40px;" id="BasicSettings-IrisDevices-Channel-{{:num}}">0</button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#" onclick="$('#BasicSettings-IrisDevices-Channel-{{:num}}').html('0'); generalValChanged('BasicSettings-IrisDevices-{{:num}}');">0</a>
                    <a class="dropdown-item" href="#" onclick="$('#BasicSettings-IrisDevices-Channel-{{:num}}').html('1'); generalValChanged('BasicSettings-IrisDevices-{{:num}}');">1</a>
                </div>
            </div>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                    style="width: 47px;" id="BasicSettings-IrisDevices-Direction-{{:num}}">Rx</button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#" onclick="$('#BasicSettings-IrisDevices-Direction-{{:num}}').html('Rx'); generalValChanged('BasicSettings-IrisDevices-{{:num}}');">Rx</a>
                    <a class="dropdown-item" href="#" onclick="$('#BasicSettings-IrisDevices-Direction-{{:num}}').html('Tx'); generalValChanged('BasicSettings-IrisDevices-{{:num}}');">Tx</a>
                </div>
            </div>
            <div class="input-group-append" style="width: 10px;">
                <div class="input-group-text" style="width: 10px;">
                    <input type="checkbox" id="BasicSettings-IrisDevices-Trigger-{{:num}}" style="margin-left: -5px;" onclick="generalValChanged('BasicSettings-IrisDevices-{{:num}}');">
                </div>
            </div>
            <div class="modified-warning" id="m-BasicSettings-IrisDevices-{{:num}}">* argument modified but not sync yet.</div>
        </div>
    </script>

    <script id='GraphShowTemplate' type="text/html">
        <div>
            <font>({{:num}}):</font>&nbsp;
            <input type="checkbox" onclick="updateManualGraph();" id="OriginGraphCheckI-{{:num}}">I&nbsp;
            <input type="checkbox" onclick="updateManualGraph();" id="OriginGraphCheckQ-{{:num}}">Q
            <br/>
            <div style="height: 150px;" id="OriginGraph-{{:num}}"></div>
        </div>
    </script>

    <script id='SystemExtraInfosTemplate' type="text/html">
        <div id="SystemExtraInfos-DIV-{{:num}}">
            <strong>Num {{:num}} (<font id="SystemExtraInfos-Serial-{{:num}}">UNKNOWN</font>):</strong>
            <ul>
                <li>LMS7 temp.: <strong id="SystemExtraInfos-LMS7-{{:num}}">UNKNOWN</strong></li>
                <li>Zynq temp.: <strong id="SystemExtraInfos-Zynq-{{:num}}">UNKNOWN</strong></li>
                <li>Frontend temp.: <strong id="SystemExtraInfos-Frontend-{{:num}}">UNKNOWN</strong></li>
                <li>PA0 temp.: <strong id="SystemExtraInfos-PA0-{{:num}}">UNKNOWN</strong></li>
                <li>PA1 temp.: <strong id="SystemExtraInfos-PA1-{{:num}}">UNKNOWN</strong></li>
            </ul>
        </div>
    </script>

    <script id='IrisGainSettingsTemplate' type="text/html">
        <div id="GainSettings-{{:TorR}}XDIV-0">
            <strong>{{:TorR}}x (0) "0013":</strong>
            <!-- add gain settings here (IrisGainSettingsSingleInputTemplate) -->
        </div>
    </script>

    <script id='IrisGainSettingsSingleInputTemplate' type="text/html">
        <div class="form-group row" style="margin-bottom: 2px;">
            <label class="col-form-label" style="margin-left: 30px;"><strong>Â· {{:gainKey}}</strong></label>
            <div class="col-sm-6">
                <!-- å…è®¸è¾“å…¥ç‰¹æ®Šå­—ç¬¦ï¼Œå› ä¸ºå¯èƒ½éœ€è¦è®¾ç½®precodeè¿™ç§å¤æ•°ï¼Ÿä¸ç®¡äº†ï¼Œç›´æ¥å­—ç¬¦ä¸²å‘è¿‡å»å¥½äº† -->
                <input type="text" class="form-control form-control-sm" placeholder="Iris count" id="GainSettings-{{:TorR}}x-{{:TorRnum}}-{{:gainKey}}" value="0"
                onKeyPress="if (event.keyCode == 13) event.srcElement.blur();"
                onblur="generalValChanged('GainSettings-{{:TorR}}x-{{:TorRnum}}-{{:gainKey}}');" >
            </div>
        </div>
    </script>

    <script id="DynamicAlertTemplate" type="text/html">
        <div class="alert alert-{{:alertType}} alert-dismissible fade show" role="alert">
            {{:msg}}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </script>

    <script>
        var nowSettings = {};  // å­—å…¸è®°å½•ç”¨æˆ·è¾“å‡ºæ“ä½œä¹‹å‰çš„å€¼ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰æ”¹å˜è¾“å…¥åˆ™ä¸è§¦å‘å‘é€
        var settingKeys = ["BasicSettings-IrisCount"];
        var settingMode = '';
        var userModified = {};
        function initNowValue() {
            for (let key in settingKeys) {
                nowSettings[settingKeys[key]] = $("#" + settingKeys[key]).val();  // åˆå§‹åŒ–è¿™äº›å€¼æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°å¤ªå¤šçº¢è‰²è­¦å‘Šï¼Œä¸ä»£è¡¨æœåŠ¡å™¨çœŸçš„æ˜¯è¿™äº›å‚æ•°
            }
        }
        $(initNowValue);  // å½“æ–‡æ¡£å‡†å¤‡å¥½åinit
        function IrisCountChangeValue(val) {
            let tar = parseInt(val) + parseInt($("#BasicSettings-IrisCount").val());
            if (tar < 0) tar = 0;
            $("#BasicSettings-IrisCount").val(tar);
            generalValChanged("BasicSettings-IrisCount");
        }
        function updateIrisCount(val) {
            let box = $("#IrisDevicesBox");
            let nlen = box.children().length;
            if (val > nlen) {  // æ·»åŠ å­å…ƒç´ 
                for (let i = nlen; i<val; ++i) {
                    box.append($.templates("#IrisSerialInput").render({num: i}));
                    let tarid = 'BasicSettings-IrisDevices-' + (i);
                    if (tarid in nowSettings) setFullIrisDeviceString(tarid, nowSettings[tarid]); // å¦‚æœè¿˜æ²¡æœ‰è·ŸæœåŠ¡å™¨åŒæ­¥ï¼Œåˆ™å…ˆå‡ååŠ åº”è¯¥ä¿ç•™åŸæ¥åºåˆ—å·
                    // generalValChanged('BasicSettings-IrisDevices-' + (i+1));  // ä¸éœ€è¦æ›´æ–°
                }
            } else if (val < nlen) {  // åˆ é™¤å­å…ƒç´ 
                for (let i = nlen-1; i>=val; --i) {
                    $("#BasicSettings-IrisDevices-Box-" + i).remove();  // åˆ é™¤çˆ¶å…ƒç´ 
                }
            }
        }
        function filter(key, val) {  // ä¸ºäº†é˜²æ­¢æœ‰çš„å€¼è¶…å‡ºèŒƒå›´ï¼Œè¿™é‡Œåšä¸€ä¸ªfilteræ“ä½œï¼Œä¿®æ­£ç”¨æˆ·è¾“å…¥
            if (key == "BasicSettings-IrisCount") {
                val = parseInt(val);
                if (val < 0 || isNaN(val) || val > 200) {
                    console.error('BasicSettings-IrisCount input error, set to 0');
                    val = 0;
                }
                $("#" + key).val(val);
                updateIrisCount(val);
            }
            return val;
        }
        function getFullIrisDeviceString(key) {
            let prefix = "BasicSettings-IrisDevices-";
            let num = key.slice(prefix.length);
            let serial = $("#" + prefix + "Serial-" + num).val();
            let channel = $("#" + prefix + "Channel-" + num).html();
            let direction = $("#" + prefix + "Direction-" + num).html();
            let trigger = document.getElementById(prefix + "Trigger-" + num).checked;  // if use as trigger source
            return "" + serial + "-" + channel + "-" + direction + "-" + (trigger?1:0);
        }
        function setFullIrisDeviceString(key, val) {
            let prefix = "BasicSettings-IrisDevices-";
            let num = key.slice(prefix.length);
            let serial=null, channel=null, direction=null, trigger=null;
            let a = val.lastIndexOf('-'); if (a != -1) trigger = (val.slice(a+1) == "1");
            let b = val.slice(0, a).lastIndexOf('-'); if (b != -1) direction = val.slice(b+1, a);
            let c = val.slice(0, b).lastIndexOf('-'); if (c != -1) channel = val.slice(c+1, b);
            serial = c == -1 ? "" : val.slice(0, c);
            if (channel && direction && (trigger != null)) {
                $("#" + prefix + "Serial-" + num).val(serial);
                $("#" + prefix + "Channel-" + num).html(channel);
                $("#" + prefix + "Direction-" + num).html(direction);
                document.getElementById(prefix + "Trigger-" + num).checked = trigger;
            } else console.error("Iris device string format error: " + val);

        }
        function generalValChanged(key) {
            let val = $("#" + key).val();
            if (key.startsWith("BasicSettings-IrisDevices-")) {  // special handle this
                val = getFullIrisDeviceString(key);
            }
            val = filter(key, val);  // ä¸ºäº†é˜²æ­¢æœ‰çš„å€¼è¶…å‡ºèŒƒå›´ï¼Œè¿™é‡Œåšä¸€ä¸ªfilteræ“ä½œï¼Œä¿®æ­£ç”¨æˆ·è¾“å…¥
            if (key in nowSettings && nowSettings[key] == val) {  // ç”¨æˆ·è™½ç„¶ç‚¹å‡»äº†inputæ¡†ï¼Œä½†ä¸æœåŠ¡å™¨ç«¯çš„å€¼ç›¸åŒï¼ˆæˆ–è®¸æ²¡æœ‰æ”¹å˜è¾“å…¥æ¡†ï¼Œåˆæˆ–è®¸è¾“å…¥çš„åˆšå¥½å’ŒæœåŠ¡å™¨ä¸€æ ·äº†ï¼‰
                $("#m-" + key).hide();
                if (key in userModified) delete userModified[key];  // ä»ç”¨æˆ·ä¿®æ”¹åˆ—è¡¨ä¸­åˆ é™¤
                return;
            }
            // console.log("generalValChanged: \"" + key + "\"");
            // console.log(val);
            $("#m-" + key).show();  // æ˜¾ç¤ºåœ°å‘Šè¯‰ç”¨æˆ·è¿™ä¸ªå…ƒç´ æ²¡æœ‰è¢«åŒæ­¥
            userModified[key] = val;  // æ›´æ–°è¡¨
            if (settingMode == 'auto') syncSettingsToServer();
        }
        function idInDOM(id) {
            return ($("#" + id).length > 0)
        }
        function updateSettingsNotSyncFlag(ignoreUserSet=false) {  // å¯¹æ‰€æœ‰åœ¨nowSettingsä¸­çš„keyåšåˆ¤æ–­
            for (let key in nowSettings) {
                if (idInDOM(key) || (key.startsWith("BasicSettings-IrisDevices-") && idInDOM("m-" + key))) {  // ä¸å­˜åœ¨çš„å…ƒç´ ä¸ç®¡
                    if ($('#m-' + key).is(':hidden')) {  // åªæœ‰hiddençš„ï¼Œæ‰æ˜¯æ²¡æœ‰ç”¨æˆ·ä¿®æ”¹è¿‡çš„ï¼Œç³»ç»Ÿæ‰èƒ½å¤Ÿæ­£å¸¸å»ä¿®æ”¹ä»–
                        $('#' + key).val(nowSettings[key]);
                    } else {
                        if (ignoreUserSet) {
                            if (key.startsWith("BasicSettings-IrisDevices-")) setFullIrisDeviceString(key, nowSettings[key]);  // special case: multiple html component for one value
                            else $('#' + key).val(nowSettings[key]);
                        }
                        // è‹¥ç³»ç»Ÿå’Œå½“å‰ç”¨æˆ·è®¾ç½®çš„ä¸€è‡´äº†ï¼Œå–æ¶ˆç”¨æˆ·å®šä¹‰
                        if ((key.startsWith("BasicSettings-IrisDevices-") && getFullIrisDeviceString(key) == nowSettings[key]) || $('#' + key).val() == nowSettings[key]) $("#m-" + key).hide();
                    }
                }
            }
        }
        function rejectAllModification() {  // è·Ÿæœ¬åœ°ä¿å­˜çš„nowSettingsä¿æŒä¸€è‡´ï¼Œå¿½ç•¥ç”¨æˆ·è¾“å…¥
            updateIrisCount(parseInt(nowSettings['BasicSettings-IrisCount']));  // TODO: ä¿®æ”¹å…¶ä»–ç»“æ„
            updateSettingsNotSyncFlag(ignoreUserSet=true);
        }
        function settingsUpdateFromServer(settings) {  // æœåŠ¡å™¨å‘è¿‡æ¥å½“å‰çš„settings
            $('#SystemBasicInfo-SystemVersion').html(settings.version);
            $('#SystemBasicInfo-RunStatus').html(settings.state);
            if (settings.state == "stopped") {  // stopped stop-pending
                $('#Init').removeAttr("disabled");  $('#Stop').attr("disabled", "disabled"); $("#SystemBasicInfo-RunStatus").css('color', 'red');
            } else if (settings.state == "running") {  // running run-pending
                $('#Stop').removeAttr("disabled");  $('#Init').attr("disabled", "disabled"); $("#SystemBasicInfo-RunStatus").css('color', 'green');
            } else {
                $('#Init').attr("disabled", "disabled"); $('#Stop').attr("disabled", "disabled"); $("#SystemBasicInfo-RunStatus").css('color', 'magenta');
            }
            nowSettings = settings.userSettings;  // ä¿å­˜åœ¨æœ¬åœ°ï¼Œå¹¶ä¸”æ›´æ–°ä»¥ä¸‹æ•°æ®ç»“æ„
            // å…ˆä¿®å¤å„ç§æ•°æ®ç»“æ„ï¼ŒæŠŠè¯¥åˆ é™¤çš„å…ƒç´ åˆ é™¤ï¼Œè¯¥å¢åŠ çš„å…ƒç´ å¢åŠ 
            if ($('#m-BasicSettings-IrisCount').is(':visible') && parseInt(nowSettings['BasicSettings-IrisCount']) != parseInt($('#BasicSettings-IrisCount').val())) {  // ç”¨æˆ·ä¿®æ”¹æ•°é‡äº†ï¼
                // do nothing é¬¼çŸ¥é“ç”¨æˆ·åœ¨å¹²ä»€ä¹ˆï¼Œä¸‡ä¸€åœ¨æ”¹å…¶ä»–æ•°æ®ç»“æ„å‘¢
                console.warn('User is changing IrisCount, so system will not update structure of user settings.');
            } else {
                updateIrisCount(parseInt(nowSettings['BasicSettings-IrisCount']));  // TODO: ä¿®æ”¹å…¶ä»–ç»“æ„
            }
            updateDrawOriginSize(parseInt(nowSettings['BasicSettings-IrisCount']));
            updateSettingsNotSyncFlag();
        }
        function changeSetMode(mode) {
            settingMode = mode;
            if (mode == 'auto') {
                syncSettingsToServer();
            }
        }
        function extraInfosFromServer(extraInfos) {
            let len = $('#SystemExtraInfos-body').children().length;
            for (let i=0; i<len; ++i) {
                if ("LMS7-" + i in extraInfos) $("#SystemExtraInfos-LMS7-" + i).html(extraInfos["LMS7-" + i]);
                if ("Zynq-" + i in extraInfos) $("#SystemExtraInfos-Zynq-" + i).html(extraInfos["Zynq-" + i]);
                if ("Frontend-" + i in extraInfos) $("#SystemExtraInfos-Frontend-" + i).html(extraInfos["Frontend-" + i]);
                if ("PA0-" + i in extraInfos) $("#SystemExtraInfos-PA0-" + i).html(extraInfos["PA0-" + i]);
                if ("PA1-" + i in extraInfos) $("#SystemExtraInfos-PA1-" + i).html(extraInfos["PA1-" + i]);
            }
        }


        // ç»˜å›¾æ“ä½œ
        var originData = {}; //{'I1': [1,2,2.5,2,1,0], 'Q1': [0,1,2,2.5,2,1]};
        var grefers = [];
        var grefAll = null;
        var grefManual = null;
        function updateOrginGraph(i) {
            let data = [];
            if ('I' + i in originData && 'Q' + i in originData && originData['I'+i].length == originData['Q'+i].length) {
                let glen = originData['I'+i].length;
                for (let j=0; j<glen; ++j) {
                    data.push([j, originData['I'+i][j], originData['Q'+i][j]]);
                }
            }
            grefers[i].updateOptions( { 'file': data } );
        }
        function updateMultipleGraph(graphref, checked) {
            let minlen = -1;
            for (let i=0; i<checked.length; ++i) {  // è·Ÿæœ€å°çš„é•¿åº¦å¯¹é½
                if (checked[i] in originData) {
                    if (minlen == -1 || minlen > originData[checked[i]].length) minlen = originData[checked[i]].length;
                } else {
                    checked.splice(i, 1);
                    console.error('cannot found ' + i + ' data, ignored');
                    --i;
                }
            }
            // if (minlen == -1) return;  // å…è®¸ç»˜åˆ¶ç©ºå›¾
            let data = [];
            for (let i=0; i<minlen; ++i) {
                let subdat = [i];
                for (let j=0; j<checked.length; ++j) {
                    subdat.push(originData[checked[j]][i]);
                }
                data.push(subdat);
            }
            let labels = ['X'];
            for (let j=0; j<checked.length; ++j) {
                labels.push(checked[j])
            }
            graphref.updateOptions({
                'labels': labels,
                'file': data
            })
        }
        function updateAllInOneGraph() {
            let nowLen = $('#OriginGraph-body').children().length;
            let checked = [];
            for (let i=0; i<nowLen; ++i) {
                checked.push('I' + i);
                checked.push('Q' + i);
            }
            if (checked.length == 0) return;
            updateMultipleGraph(grefAll, checked);
        }
        function updateAllOriginGraph() {
            let nowLen = $('#OriginGraph-body').children().length;
            for (let i=0; i<nowLen; ++i) updateOrginGraph(i);
        }
        function updateManualGraph() {
            let nowLen = $('#OriginGraph-body').children().length;
            let checked = [];
            for (let i=0; i<nowLen; ++i) {
                if (document.getElementById('OriginGraphCheckI-' + i).checked) checked.push('I' + i);
                if (document.getElementById('OriginGraphCheckQ-' + i).checked) checked.push('Q' + i);
            }
            // if (checked.length == 0) return;  // if 0, just print none of them
            updateMultipleGraph(grefManual, checked);
        }
        function updateDrawOriginSize(cnt) {
            let nowLen = $('#OriginGraph-body').children().length;
            if (cnt > nowLen) {  // åˆ›å»ºæ›´å¤š
                for (let i=nowLen; i<cnt; ++i) {
                    $('#OriginGraph-body').append($.templates("#GraphShowTemplate").render({num: i}));
                    let g = new Dygraph(  // ä¼šå¯¼è‡´ä¸€äº›å†…å­˜æµªè´¹ï¼Œä¸è¿‡è¿™éƒ¨åˆ†ä¸æ€ä¹ˆå˜åŠ¨ï¼Œä¹Ÿè¿˜å¥½
                        document.getElementById("OriginGraph-" + i),
                        [],
                        {
                            labels: ['X', 'I', 'Q'],
                            drawPoints: true,
                            drawAxesAtZero: true,
                            strokeWidth: 1
                        }
                    );
                    grefers[i] = g;
                }
            } else if (cnt < nowLen) {
                for (let i=nowLen-1; i>=cnt; --i) {
                    grefers[i].destroy();
                    $('#OriginGraph-body').children()[i].remove();
                }
            }
            updateAllOriginGraph();
            console.log(originData);
        }
        $(function() {
            grefAll = new Dygraph(
                document.getElementById("AllInOneGraph-0"),
                [],
                {
                    labels: ['X'],
                    drawPoints: true,
                    drawAxesAtZero: true,
                    strokeWidth: 1,
                    showRangeSelector: true
                }
            );
            grefManual = new Dygraph(
                document.getElementById("ManualGraph-0"),
                [],
                {
                    labels: ['X'],
                    drawPoints: true,
                    drawAxesAtZero: true,
                    strokeWidth: 1,
                    showRangeSelector: true
                }
            )
        });
        function samplesFromServer(samples) {
            originData = samples;
            updateAllInOneGraph();
            updateAllOriginGraph();
            updateManualGraph();
        }



        

        // é€šä¿¡éƒ¨åˆ†ï¼Œé€»è¾‘ä¸åœ¨ä»¥ä¸‹éƒ¨åˆ†å®ç°
        var socketio = null;  // å…¨å±€å˜é‡ï¼Œwebsocket clientå¯¹è±¡
        var connectTimeout = null;  // å…¨å±€å˜é‡ï¼Œå½“è¿ç»­3ä¸ªå¿ƒè·³åŒ…ä¸¢å¤±æ—¶ï¼Œç³»ç»Ÿæ˜¾ç¤ºâ€œæœªè¿æ¥â€
        $(function() {  // åˆå§‹åŒ–é€šä¿¡éƒ¨åˆ†
            socketio = io.connect(location.protocol + '//' + document.domain + ':' + location.port + '/');
            console.log(socketio);
            socketio.on('connect', function(socket) {
                console.log('connected to server at ' + Date().toLocaleString());
                $('#SystemBasicInfo-Connected').html('True');
                $('#SystemBasicInfo-Connected').css('color', 'green');
            });
            socketio.on('disconnect', function(socket) {
                console.log('disconnect from server at ' + Date().toLocaleString());
                $('#SystemBasicInfo-Connected').html('False');
                $('#SystemBasicInfo-Connected').css('color', 'red');
            });
            socketio.on('settings', function(settings) {
                // console.log(settings);
                settingsUpdateFromServer(settings);  // äº¤ç»™é€»è¾‘å±‚
            });
            socketio.on('samples', function(samples) {
                samplesFromServer(samples);
            });
            socketio.on('extraInfos', function(extraInfos) {
                extraInfosFromServer(extraInfos);
            });
            socketio.on('log', function(msg) {
                console.log(msg);
            });
            socketio.on('alert', function(msg) {
                $("#SystemLogs-body").append($.templates("#DynamicAlertTemplate").render({alertType: "warning", msg: msg}));
            });
            socketio.on('error', function(msg) {
                console.error(msg);
                $("#SystemLogs-body").append($.templates("#DynamicAlertTemplate").render({alertType: "danger", msg: msg}));
            });
        });
        function leftButtonClicked(id) {
            if (id == 'Reset') socketio.emit('button', 'reset');
            if (id == 'Init') socketio.emit('button', 'init');
            if (id == 'Stop') socketio.emit('button', 'stop');
            if (id == 'Trig') socketio.emit('button', 'trig');
        }
        function syncSettingsToServer() {
            console.log(userModified);
            socketio.emit('syncSettings', userModified);
            userModified = {};
        }
    </script>

</body>
</html>

